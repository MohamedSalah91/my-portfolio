name: CI/CD Pipeline for Portfolio

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ” Validate project structure
      run: |
        set -e
        echo "Checking required files..."

        [ -f Dockerfile ] || (echo "âŒ Dockerfile not found" && exit 1)
        [ -f src/index.html ] || (echo "âŒ index.html not found" && exit 1)

        echo "âœ… All required files are present"

    - name: ðŸ³ Build Docker image
      run: |
        set -e
        echo "Building Docker image..."
        docker build -t portfolio:${{ github.sha }} .
        echo "âœ… Docker image built successfully"

    - name: ðŸ§ª Test Docker container
      run: |
        set -e

        cleanup() {
          docker stop test-container || true
          docker rm test-container || true
        }
        trap cleanup EXIT

        echo "Starting container..."
        docker run -d --name test-container -p 8080:80 portfolio:${{ github.sha }}
        sleep 5

        echo "Testing HTTP response..."
        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)

        if [ "$STATUS_CODE" != "200" ]; then
          echo "âŒ ERROR: HTTP $STATUS_CODE"
          exit 1
        fi

        echo "âœ… Container responded with HTTP 200"

    - name: ðŸ“Š Success report
      run: |
        echo "## ðŸŽ‰ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** portfolio:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
